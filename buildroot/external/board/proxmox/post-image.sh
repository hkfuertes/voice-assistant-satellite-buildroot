#!/bin/bash
set -e

###############################################################################
# Post-image script: Rename rootfs with arch and create Dockerfile
# Usage: BR2_ROOTFS_POST_IMAGE_SCRIPT="board/rename_and_dockerfile.sh"
###############################################################################

IMAGES_DIR="${BINARIES_DIR}"
ROOTFS_TAR="${IMAGES_DIR}/rootfs.tar.xz"

if [ -n "${BR2_ARCH}" ]; then
    ARCH="${BR2_ARCH}"
else
    ARCH=$(uname -m)
fi

case "${ARCH}" in
    x86_64|amd64)
        ARCH="amd64"
        DOCKER_PLATFORM="linux/amd64"
        ;;
    aarch64|arm64)
        ARCH="arm64"
        DOCKER_PLATFORM="linux/arm64"
        ;;
    armv7l|arm)
        ARCH="armv7"
        DOCKER_PLATFORM="linux/arm/v7"
        ;;
    i386|i686)
        ARCH="i386"
        DOCKER_PLATFORM="linux/386"
        ;;
    *)
        echo "WARNING: Unknown architecture '${ARCH}', using as-is"
        DOCKER_PLATFORM="linux/${ARCH}"
        ;;
esac

NEW_NAME="voice-assistant_rootfs_${ARCH}.tar.xz"
ROOTFS_RENAMED="${IMAGES_DIR}/${NEW_NAME}"
DOCKERFILE="${IMAGES_DIR}/Dockerfile"

echo "========================================"
echo "Post-image: Rename and Dockerfile"
echo "========================================"
echo "Architecture: ${ARCH}"
echo "Platform: ${DOCKER_PLATFORM}"
echo

if [ -f "${ROOTFS_TAR}" ]; then
    mv "${ROOTFS_TAR}" "${ROOTFS_RENAMED}"
    echo "[+] Created: ${ROOTFS_RENAMED}"
else
    echo "ERROR: ${ROOTFS_TAR} not found!"
    exit 1
fi

cat > "${DOCKERFILE}" <<EOF
# Dockerfile auto-generated by Buildroot post-image script
# Architecture: ${ARCH}
# Platform: ${DOCKER_PLATFORM}
# Build date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

FROM scratch

# Metadata
LABEL maintainer="hkfuertes@gmail.com"
LABEL description="Voice Assistant - Buildroot ${ARCH}"
LABEL version="1.0.0"
LABEL architecture="${ARCH}"
LABEL build.date="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

# Add rootfs
ADD ${NEW_NAME} /

# Environment variables
ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ENV LANG=C.UTF-8
ENV ARCH=${ARCH}

# Work directory
WORKDIR /root

# Default command
CMD ["/bin/sh"]
EOF

echo "[+] Created: ${DOCKERFILE}"

echo
echo "========================================"
echo "[+] Post-image completed successfully!"
echo "========================================"
echo
echo "Generated files in ${IMAGES_DIR}:"
echo "  - ${NEW_NAME}"
echo "  - Dockerfile"
echo
echo "To build Docker image:"
echo "  cd ${IMAGES_DIR}"
echo "  docker build -t voiceassistant:${ARCH} ."
echo
