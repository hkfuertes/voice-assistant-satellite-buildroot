#!/bin/sh

DAEMON="linux-voice-assistant"
PIDFILE="/var/run/$DAEMON.pid"
CONFIG="/etc/linux-voice-assistant/config"

# Load configuration
[ -f "$CONFIG" ] && . "$CONFIG"

# Build command line arguments
ARGS="--name ${SATELLITE_NAME:-VoiceSatellite}"

if [ -n "$WAKE_MODEL" ]; then
    ARGS="$ARGS --wake-model $WAKE_MODEL"
fi

if [ -n "$AUDIO_INPUT_DEVICE" ]; then
    ARGS="$ARGS --audio-input-device \"$AUDIO_INPUT_DEVICE\""
fi

if [ -n "$AUDIO_OUTPUT_DEVICE" ]; then
    ARGS="$ARGS --audio-output-device \"$AUDIO_OUTPUT_DEVICE\""
fi

# Set wakewords directory
export LINUX_VOICE_ASSISTANT_WAKEWORDS_DIR="/usr/share/linux-voice-assistant/wakewords"

start() {
    echo -n "Starting $DAEMON: "
    
    # Check if already running
    if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
        echo "already running"
        return 1
    fi
    
    # Start the daemon
    start-stop-daemon -S -b -m -p "$PIDFILE" \
        -x /usr/bin/python3 -- -m linux_voice_assistant $ARGS
    
    [ $? = 0 ] && echo "OK" || echo "FAIL"
}

stop() {
    echo -n "Stopping $DAEMON: "
    start-stop-daemon -K -p "$PIDFILE" -s TERM
    [ $? = 0 ] && echo "OK" || echo "FAIL"
    rm -f "$PIDFILE"
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0
