#!/bin/sh

BOOT_MOUNTED=0
WPA_CONF="/etc/wpa_supplicant.conf"

case "$1" in
  start)
    echo "Configuring WiFi..."
    
    mkdir -p /boot
    
    # Check if /boot is already mounted
    if ! mountpoint -q /boot 2>/dev/null; then
      mount /dev/mmcblk0p1 /boot 2>/dev/null && BOOT_MOUNTED=1
    fi
    
    # Copy wpa_supplicant.conf from /boot if exists
    if [ -f /boot/wpa_supplicant.conf ]; then
      echo "Found wpa_supplicant.conf in /boot, copying to /etc/"
      cp /boot/wpa_supplicant.conf "$WPA_CONF"
      chmod 600 "$WPA_CONF"
    elif [ -f "$WPA_CONF" ]; then
      echo "Using existing wpa_supplicant.conf from /etc/"
    else
      echo "No wpa_supplicant.conf found in /boot or /etc/"
      [ $BOOT_MOUNTED -eq 1 ] && umount /boot
      exit 0
    fi
    
    # Unmount /boot if we mounted it
    [ $BOOT_MOUNTED -eq 1 ] && umount /boot
    
    # Start WiFi with wpa_supplicant
    echo "Connecting to WiFi..."
    mkdir -p /var/run/wpa_supplicant
    ip link set wlan0 up
    sleep 1
    wpa_supplicant -B -i wlan0 -c "$WPA_CONF"
    sleep 3
    udhcpc -i wlan0 -b -q

    iwconfig wlan0 power off 2>/dev/null
    echo "WiFi configured"
    ;;
    
  stop)
    killall wpa_supplicant 2>/dev/null
    killall udhcpc 2>/dev/null
    ip link set wlan0 down 2>/dev/null
    ;;
    
  *)
    echo "Usage: $0 {start|stop}"
    exit 1
    ;;
esac

exit 0
