#!/bin/sh

FLAG="/RESIZED"
ROOT_PART="$(findmnt -n -o SOURCE /)"

[ -f "$FLAG" ] && exit 0

echo "Expanding root filesystem..."

# Remount read-only for safety
mount -o ro,remount /

# Disable resize_inode feature to allow online resize
tune2fs -O^resize_inode "$ROOT_PART" 2>/dev/null

# Check and repair filesystem
echo "Checking filesystem..."
fsck.ext4 -yDf "$ROOT_PART" >/dev/null 2>&1

# Remount read-write
mount -o rw,remount /

# Expand filesystem to fill partition
echo "Resizing filesystem..."
resize2fs "$ROOT_PART" >/dev/null 2>&1

if [ $? -eq 0 ]; then
    touch "$FLAG"
    echo "Filesystem expanded successfully"
    exit 0
else
    echo "ERROR: Failed to expand filesystem"
    exit 1
fi
