#!/bin/sh

FLAG="/RESIZED"
PART_FLAG="/PART_RESIZED"
ROOT_DEV="/dev/mmcblk0"
ROOT_PART="/dev/mmcblk0p2"

# Already completed everything
[ -f "$FLAG" ] && exit 0

# Phase 1: Expand partition
if [ ! -f "$PART_FLAG" ]; then
    echo "=== Phase 1: Expanding partition ==="
    
    echo ", +" | sfdisk --no-reread -N 2 "$ROOT_DEV"
    
    if [ $? -ne 0 ]; then
        echo "ERROR: Failed to resize partition"
        exit 1
    fi
    
    touch "$PART_FLAG"
    echo "Partition expanded. Rebooting to apply changes..."
    return 0  # Return to init script which will reboot
fi

# Phase 2: Expand filesystem (after reboot)
echo "=== Phase 2: Expanding filesystem ==="
resize2fs "$ROOT_PART"

if [ $? -eq 0 ]; then
    touch "$FLAG"
    rm -f "$PART_FLAG"
    echo "=== Complete ==="
    df -h /
    exit 0
else
    echo "ERROR: resize2fs failed"
    exit 1
fi
